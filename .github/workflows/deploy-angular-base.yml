name: Deploy Angular Base to Demo

on:
  push:
    branches: [ main ]
    paths: [ 'angular-base/**' ]
  workflow_dispatch: # Pozwala na rÄ™czne uruchomienie

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: 'angular-base/mybase/package-lock.json'
          
      - name: Install dependencies
        run: |
          cd angular-base/mybase
          npm ci
          
      - name: Run tests
        run: |
          cd angular-base/mybase
          npm run test:jest
          
      - name: Build Angular app
        run: |
          cd angular-base/mybase
          npm run build
          
      - name: Deploy to server
        run: |
          cd angular-base
          chmod +x deploy.sh
          ./deploy.sh
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          
      - name: Health check
        run: |
          sleep 10
          curl -f https://demo.szwagrzak.pl || exit 1
